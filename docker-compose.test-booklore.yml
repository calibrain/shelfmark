# Test stack for Booklore API integration
# Includes shelfmark + Booklore + MariaDB on same network
#
# Usage:
#   docker compose -f docker-compose.test-booklore.yml up -d
#   # Access shelfmark at http://localhost:8184
#   # Access Booklore at http://localhost:6061
#
# Setup:
#   1. Open Booklore at http://localhost:6061 and create an account
#   2. Create a library in Booklore and note the library ID and path ID
#   3. In Shelfmark Settings > Downloads:
#      - Set Output Mode to "Booklore (API)"
#      - Configure Booklore URL: http://booklore:6060
#      - Enter your Booklore credentials and library/path IDs
#

services:
  shelfmark:
    build:
      context: .
      dockerfile: Dockerfile
      target: shelfmark
    container_name: test-shelfmark
    cap_add:
      - SYS_PTRACE
    environment:
      TZ: UTC
      DEBUG: "true"
      # Booklore configuration done via Settings UI:
      #   - BOOKLORE_HOST: http://booklore:6060
      #   - BOOKLORE_USERNAME: <your username>
      #   - BOOKLORE_PASSWORD: <your password>
      #   - BOOKLORE_LIBRARY_ID: <library id>
      #   - BOOKLORE_PATH_ID: <path id>
      #   - BOOKLORE_VERIFY_TLS: false (internal network)
    ports:
      - "8184:8084"
    volumes:
      # Config and state
      - ./.local/test-booklore/shelfmark/config:/config
      - ./.local/test-booklore/shelfmark/log:/var/log/shelfmark
      # Book destination directory (for folder mode fallback)
      - ./.local/test-booklore/books:/books
      # Staging directory
      - ./.local/test-booklore/tmp:/tmp/shelfmark
      # Mount source code for hot-reload (no rebuild needed for Python changes)
      - ./shelfmark:/app/shelfmark:ro
      # Mount tests for running pytest in container
      - ./tests:/app/tests:ro
      - ./pyproject.toml:/app/pyproject.toml:ro
    depends_on:
      - booklore
    restart: unless-stopped

  booklore:
    image: booklore/booklore:latest
    container_name: test-booklore
    environment:
      - USER_ID=1000
      - GROUP_ID=1000
      - TZ=UTC
      - BOOKLORE_PORT=6060
      - DATABASE_URL=jdbc:mariadb://mariadb:3306/booklore
      - DATABASE_USERNAME=booklore
      - DATABASE_PASSWORD=booklore
    volumes:
      - ./.local/test-booklore/booklore/data:/app/data
      - ./.local/test-booklore/booklore/books:/books
      - ./.local/test-booklore/booklore/bookdrop:/bookdrop
    ports:
      - "6061:6060"
    depends_on:
      mariadb:
        condition: service_healthy
    restart: unless-stopped

  mariadb:
    image: lscr.io/linuxserver/mariadb:11.4.5
    container_name: test-booklore-db
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=UTC
      - MYSQL_ROOT_PASSWORD=rootpassword
      - MYSQL_DATABASE=booklore
      - MYSQL_USER=booklore
      - MYSQL_PASSWORD=booklore
    volumes:
      - ./.local/test-booklore/mariadb/config:/config
    healthcheck:
      test: ["CMD", "mariadb-admin", "ping", "-h", "localhost"]
      interval: 5s
      timeout: 5s
      retries: 10
    restart: unless-stopped
